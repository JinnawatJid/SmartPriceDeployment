# เงื่อนไขการใช้ราคาจากประวัติการซื้อ

## สรุปฟีเจอร์
เพิ่มเงื่อนไขการกำหนดราคาสินค้า: **หากลูกค้าเคยซื้อสินค้าชิ้นนั้นในราคาที่สูงกว่าราคาระบบ ให้ใช้ราคาครั้งก่อนแทน**

## การทำงาน

### Backend (pricing_router.py)
1. หลังจากคำนวณราคาด้วย `LevelPrice()` และ `Price()` แล้ว
2. ระบบจะตรวจสอบประวัติการซื้อของลูกค้าแต่ละ SKU จากตาราง `Invoice`
3. ดึงราคาล่าสุดที่ลูกค้าเคยซื้อ (`Unit Price` จาก `Invoice`)
4. เปรียบเทียบกับราคาที่คำนวณได้จากระบบ (`NewPrice`)
5. **ถ้าราคาครั้งก่อนสูงกว่า** → ใช้ราคาครั้งก่อน และเพิ่ม flag `price_source: "history"`
6. **ถ้าราคาครั้งก่อนต่ำกว่าหรือเท่ากัน** → ใช้ราคาระบบ และเพิ่ม flag `price_source: "system"`

### Frontend (CartItemRow.jsx)
1. แสดง badge "ราคาครั้งก่อน" สีส้มใต้ราคาสินค้า เมื่อ `calculatedItem.price_source === "history"`
2. ในส่วนประวัติราคา (expand row):
   - แสดง badge "✓ ใช้ราคาครั้งก่อน (สูงกว่าราคาระบบ)" ที่ header
   - แสดงราคาระบบปัจจุบันเพื่อเปรียบเทียบ

## ตัวอย่างการทำงาน

### กรณีที่ 1: ราคาครั้งก่อนสูงกว่า
```
SKU: A010010010101
ราคาระบบ: 100.00 บาท
ราคาครั้งก่อน: 120.00 บาท
→ ใช้ราคา: 120.00 บาท (แสดง badge "ราคาครั้งก่อน")
```

### กรณีที่ 2: ราคาครั้งก่อนต่ำกว่า
```
SKU: A010010010101
ราคาระบบ: 100.00 บาท
ราคาครั้งก่อน: 80.00 บาท
→ ใช้ราคา: 100.00 บาท (ไม่แสดง badge)
```

### กรณีที่ 3: ไม่มีประวัติ
```
SKU: A010010010101
ราคาระบบ: 100.00 บาท
ราคาครั้งก่อน: ไม่มี
→ ใช้ราคา: 100.00 บาท (ไม่แสดง badge)
```

## ข้อดี
1. **รักษาความสัมพันธ์กับลูกค้า**: ไม่ลดราคาที่ลูกค้าเคยซื้อ
2. **โปร่งใส**: แสดงให้เห็นว่าราคามาจากไหน
3. **ยืดหยุ่น**: พนักงานขายยังสามารถแก้ไขราคาด้วยตนเองได้

## ข้อควรระวัง
1. ใช้ราคาล่าสุดจาก Invoice เท่านั้น (ไม่ใช่ราคาเฉลี่ย)
2. ตรวจสอบเฉพาะลูกค้าที่มี customer code (ไม่ใช่ "ผู้ไม่ประสงค์ออกนาม")
3. ถ้าเกิด error ในการดึงประวัติ จะใช้ราคาระบบแทน

## ไฟล์ที่แก้ไข
- `backend/pricing_router.py` - เพิ่มการตรวจสอบประวัติราคา
- `frontend/src/components/wizard/CartItemRow.jsx` - เพิ่มการแสดง badge และข้อมูลเปรียบเทียบ
